$(document).ready(function () {

    //hide empty table
    $("#list").hide();
    $("#tbl-1").hide();

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#load").click(function () {

        //hide while refreshing table
        $("#list").hide(100);
        $("#tbl-1").hide(100);
        loadData();

    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    //show modal
    $("#btn-create").click(function () {
        $("#create-Modal").modal();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#create").click(function () {
        postData();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#update").click(function () {
        updateData();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->
    $("#delete").click(function () {
        deleteData();
    });

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */


    $('.table tbody').on('click', '.loadForUpdate', function () {
        var currentRow = $(this).closest("tr");
        var col1 = currentRow.find("td:eq(0)").html();
        var col2 = currentRow.find("td:eq(1)").html();
        var col3 = currentRow.find("td:eq(2)").html();
        var col4 = currentRow.find("td:eq(3)").html();
        var col5 = currentRow.find("td:eq(4)").html();
        var col6 = currentRow.find("td:eq(5)").html();

        $("#updautoId").html(col1);
        $("#updMemoNumber").val(col2);
        $("#updMemoDescription").val(col3);
        $("#updCreatedOn").html(col4);
        $("#updBelongsTo").html(col5);
        $("#updStatus").html(col6);

        $("#upd-Modal").modal();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */

    $('.table tbody').on('click', '.loadForDelete', function () {

        var currentRow = $(this).closest("tr");
        var col1 = currentRow.find("td:eq(0)").html();
        var col2 = currentRow.find("td:eq(1)").html();
        var col3 = currentRow.find("td:eq(2)").html();
        var col4 = currentRow.find("td:eq(3)").html();
        var col5 = currentRow.find("td:eq(4)").html();
        var col6 = currentRow.find("td:eq(5)").html();

        $("#dltautoId").html(col1);
        $("#dltMemoNumber").html(col2);
        $("#dltMemoDescription").html(col3);
        $("#dltCreatedOn").html(col4);
        $("#dltBelongsTo").html(col5);
        $("#dltStatus").html(col6);
        //alert(col1);
        $("#dlt-Modal").modal();

    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */

    $('.table tbody').on('click', '.loadForDetails', function () {

        var currentRow = $(this).closest("tr");
        var col1 = currentRow.find("td:eq(0)").html();
        var col2 = currentRow.find("td:eq(1)").html();
        var col3 = currentRow.find("td:eq(2)").html();
        var col4 = currentRow.find("td:eq(3)").html();
        var col5 = currentRow.find("td:eq(4)").html();
        var col6 = currentRow.find("td:eq(5)").html();

        col5 = $.trim(col5);
        if (col5.toLowerCase() === "purchase".toLowerCase()) {
            loadPurchaseData(col1);

        }
        if (col5.toLowerCase() == "sell".toLowerCase()) {
            loadsellData(col1);
        }
    });


    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    //Load data in table

    function loadData() {
        //delete if already created DataTable in past
        if ($.fn.DataTable.isDataTable('#list')) {
            $('#list').DataTable().clear().destroy();
        }

        $.ajax({
            url: "https://localhost:44360/api/memos",
            method: "get",
            headers: {
                //Authorization:"Basic "+btoa("admin:123")
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    var data = xmlHttp.responseJSON;
                    //console(data);
                    var str = '';
                    for (var i = 0; i < data.length; i++) {

                        var start = "<tr><td style='display:none;'>"; var end = "</td></tr>";
                        var k = "</td><td>";
                        var a1 = data[i].autoId;
                        var a2 = data[i].MemoNumber;
                        var a3 = data[i].MemoDescription;
                        var a4 = data[i].CreatedOn.substr(0, 10);
                        var a5 = data[i].BelongsTo;
                        var a6 = data[i].Status;


                        var action = "<button class='btn btn-yellow btn-lg loadForUpdate'><i class='fa fa-pencil-square' aria-hidden='true'style='color:black'></i></button>";
                        action += "&nbsp;<button class='btn btn-red btn-lg loadForDelete'><i class='fa fa-trash' aria-hidden='true'></i></button>";
                        action += "&nbsp;<button class='btn btn-green btn-lg loadForDetails'><i class='fa fa-info-circle' aria-hidden='true' style='color:black'></i></button>";

                        str += start + a1 + k + a2 + k + a3 + k + a4 + k + a5 + k + a6 + k + action + end;

                    };
                    str = str.replace(new RegExp("null", 'g'), "-");
                    $("#list tbody").html(str);



                    $('#list').DataTable({
                        dom: 'Bfrtip',
                        buttons: [
                            'copyHtml5',
                            'excelHtml5',
                            'csvHtml5',
                            'pdfHtml5'
                        ]
                    });

                    //show table
                    $("#list").show(1000);
                    $("#tbl-1").show(1000);
                    var element = document.getElementById("tbl-1");
                    element.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });

                }
                else {
                    $("#msg").html(xmlHttp.status + ":" + xmlHttp.statusText);
                }
            }
        });
    }

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    function postData() {

        $.ajax({

            url: "https://localhost:44360/api/memos",
            method: "post",
            headers:
            {
                ContentType: "application/json"
            },

            data:
            {
                // MemoNumber
                // MemoDescription
                //BelongsTo

                MemoNumber: $("#MemoNumber").val(),
                MemoDescription: $("#MemoDescription").val(),
                BelongsTo: $("#BelongsTo").val(),

            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 201) {
                    $("#postmsg").html($("#MemoNumber").val() + " Created");

                    $("#MemoNumber").val(""),
                        $("#MemoDescription").val(""),
                        $("#BelongsTo").val(""),


                        loadData();
                }

                else {
                    $("#postmsg").html(xmlHttp.responseText);
                }
            },
            success: function () {
                var s = $("#ProductName").val() + "has been inserted successfully"

            }


        });
    }
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    //update data
    function updateData() {

        /*           
MemoNumber  { auto generated if not given}
MemoDescription
CreatedOn
BelongsTo (sell or purchase)
Status (Done, onGoing) 
        */
        var id = $("#updautoId").text().trim();

        $.ajax({

            url: "https://localhost:44360/api/memos/" + id,
            method: "put",
            headers:
            {
                ContentType: "application/json"
            },

            data:
            {
                MemoNumber: $("#updMemoNumber").val().trim(),
                MemoDescription: $("#updMemoDescription").val().trim(),
                BelongsTo: $("#updBelongsTo").text().trim(),
                Status: $("#updStatus").text().trim()
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    $("#updatemsg").html($("#updautoId").text() + " has been Updated Successfully");

                    //empty update form
                    $("#updautoId").text("");
                    $("#updMemoNumber").val("");
                    $("#updMemoDescription").val("");
                    $("#updCreatedOn").text("");
                    $("#updBelongsTo").text("");
                    $("#updStatus").text("");

                    loadData();
                }
                else {
                    $("#updatemsg").html(xmlHttp.status + ":" + xmlHttp.statusText + ":" + xmlHttp.responseText);
                }
            },
            success: function () {
                //alert("success");
            }
        });
    }
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    function deleteData() {
        var id = $("#dltautoId").text().trim();
        $.ajax({
            url: "https://localhost:44360/api/memos/" + id,
            method: "delete",
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    $("#deletemsg").html(id + " has been deleted successfully");

                    //empty update form
                    $("#dltautoId").text("");
                    $("#dltMemoNumber").text("");
                    $("#dltMemoDescription").text("");
                    $("#dltCreatedOn").text("");
                    $("#dltBelongsTo").text("");
                    $("#dltStatus").text("");

                    loadData();
                }
                else {
                    $("#deletemsg").html(xmlHttp.status + ":" + xmlHttp.statusText + "" + xmlHttp.responseText);
                }
            }
        });
    }


    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */

    function loadPurchaseData(col1) {

        $.ajax({
            url: "https://localhost:44360/api/memos/" + col1 + "/purchases",
            method: "get",
            headers: {
                //Authorization:"Basic "+btoa("admin:123")
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    var data = xmlHttp.responseJSON;
                    //console(data);
                    var str = "";
                    var sum = 0;
                    for (var i = 0; i < data.length; i++) {

                        var start = "<tr><td>";
                        var end = "</td></tr>";
                        var k = "</td><td>";
                        var a1 = data[i].PurchaseId;
                        var a2 = data[i].MemoNumber;
                        var a3 = data[i].ProductId;
                        var a4 = data[i].ProductName;
                        var a5 = data[i].PurchaseDate;
                        if (a5 != null) {
                            a5 = data[i].PurchaseDate.substr(0, 10);
                        }
                        var a6 = data[i].Quantity;
                        var a7 = data[i].Price;

                        var Qp = a6 * a7;

                        sum += Qp;

                        str +=
                            start +
                            a1 +
                            k +
                            a2 +
                            k +
                            a3 +
                            k +
                            a4 +
                            k +
                            a5 +
                            k +
                            a6 +
                            k +
                            a7 +
                            k +
                            Qp +
                            end;
                    }
                    //str=str.replace(new RegExp("null", 'g'), "-");
                    $("#purchasemainlist tbody").html(str);
                    $("#total2").text(sum);

                    $("#tbl-purchase-Modal").modal();

                } else {
                    $("#msg").html(xmlHttp.status + ":" + xmlHttp.statusText);
                }
            },
        });
    }


    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */

    //done *************************************************************************************************************** */
    //Load invoice data in table

    function loadsellData(col1) {

        $.ajax({
            url: "https://localhost:44360/api/memos/" + col1 + "/sells",
            method: "get",
            headers: {
                //Authorization:"Basic "+btoa("admin:123")
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    var data = xmlHttp.responseJSON;
                    //console(data);
                    var str = "";
                    var sum = 0;
                    for (var i = 0; i < data.length; i++) {
                        /* 
                                    SellId **auto
                                    MemoNumber  **memotable
                                    ProductId **productTable
                                    ProductName <<auto from product ID>> **product Table
                                    SellDate **current date
                                    Quantity
                                    Price
                                    */
                        var start = "<tr><td>";
                        var end = "</td></tr>";
                        var k = "</td><td>";
                        var a1 = data[i].SellId;
                        var a2 = data[i].MemoNumber;
                        var a3 = data[i].ProductId;
                        var a4 = data[i].ProductName;
                        var a5 = data[i].SellDate;
                        if (a5 != null) {
                            a5 = data[i].SellDate.substr(0, 10);
                        }
                        var a6 = data[i].Quantity;
                        var a7 = data[i].Price;

                        var Qp = a6 * a7; sum += Qp;

                        str +=
                            start +
                            a1 +
                            k +
                            a2 +
                            k +
                            a3 +
                            k +
                            a4 +
                            k +
                            a5 +
                            k +
                            a6 +
                            k +
                            a7 +
                            k +
                            Qp +

                            end;
                    }
                    //str=str.replace(new RegExp("null", 'g'), "-");
                    $("#sellmainlist tbody").html(str);

                    $("#total1").text(sum);

                    $("#tbl-sell-Modal").modal();

                } else {
                    $("#msg").html(xmlHttp.status + ":" + xmlHttp.statusText);
                }
            },
        });
    }

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */





});