$(document).ready(function () {


    //hide empty table
    $("#list").hide();
    $("#tbl-main").hide();
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#btn-create").click(function () {
        $("#create-Modal").modal();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#load").click(function () {

        // loading animation
        /*
         swal.fire({
             title: "Loading...",
             text: "Please wait",
             showConfirmButton: false,
             allowOutsideClick: false
           });
           */
        $("#list").hide();
        $("#tbl-main").hide();
        loadData();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#create").click(function () {
        postData();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#update").click(function () {
        updateData();
    });
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->    
    //******************************************************************************************************************************************-->

    $("#delete").click(function () {
        deleteData();
    });


    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */


    $('.table tbody').on('click', '.loadForUpdate', function () {
        var currentRow = $(this).closest("tr");
        var col1 = currentRow.find("td:eq(0)").html();
        var col2 = currentRow.find("td:eq(1)").html();
        var col3 = currentRow.find("td:eq(2)").html();
        var col4 = currentRow.find("td:eq(3)").html();
        var col5 = currentRow.find("td:eq(4)").html();

        $("#updProductId").html(col1);
        $("#updProductName").val(col2);
        $("#updProductDescription").val(col3);
        $("#updQuantity").val(col4);
        $("#updPrice").val(col5);

        $("#upd-Modal").modal();
    });

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */

    $('.table tbody').on('click', '.loadForDelete', function () {

        var currentRow = $(this).closest("tr");
        var col1 = currentRow.find("td:eq(0)").html();
        var col2 = currentRow.find("td:eq(1)").html();
        var col3 = currentRow.find("td:eq(2)").html();
        var col4 = currentRow.find("td:eq(3)").html();
        var col5 = currentRow.find("td:eq(4)").html();

        $("#dltProductId").html(col1);
        $("#dltProductName").html(col2);
        $("#dltProductDescription").html(col3);
        $("#dltQuantity").html(col4);
        $("#dltPrice").html(col5);


        $("#dlt-Modal").modal();

    });

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    //Load data in table

    function loadData() {
        //delete if already created DataTable in past
        if ($.fn.DataTable.isDataTable('#list')) {
            $('#list').DataTable().clear().destroy();
        }

        $.ajax({
            url: "https://localhost:44360/api/products",
            method: "get",
            headers: {
                //Authorization:"Basic "+btoa("admin:123")
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    var data = xmlHttp.responseJSON;
                    //console(data);
                    var str = '';
                    for (var i = 0; i < data.length; i++) {
                        var start = "<tr><td style='display:none;'>";
                        var end = "</td></tr>";
                        var k = "</td><td>";
                        var a1 = data[i].ProductId;
                        var a2 = data[i].ProductName;
                        var a3 = data[i].ProductDescription;
                        var a4 = data[i].Quantity;
                        var a5 = data[i].Price;

                        var a6 = data[i].CreatedDate;
                        if (a6 != null) {
                            a6 = data[i].CreatedDate.substr(0, 10);
                        }

                        var a7 = data[i].ModifiedDate;
                        if (a7 != null) {
                            a7 = data[i].ModifiedDate.substr(0, 10);
                        }
                        //var a8=data[i].LastPurchasedDate; if(a8!=null){a8=data[i].LastPurchasedDate.substr(0,10);}
                        //var a9=data[i].LastSoldDate;if(a9!=null){a9=data[i].LastSoldDate.substr(0,10);}
                        var action = "<button class='btn btn-lg btn-yellow loadForUpdate'><i class='fa fa-pencil-square' aria-hidden='true'style='color:black'></i></button>";
                        action += "&nbsp;<button class='btn btn-lg btn-red loadForDelete'><i class='fa fa-trash' aria-hidden='true'></i></button>";

                        var remarks = "";
                        if (a4 == 0) {
                            remarks += "<span class='label label-danger'> Not Avilable</span>";

                        }
                        if (a4 > 0) {
                            remarks += "&nbsp;<span class='label label-success'> Avilable </span>";
                        }

                        if (a4 < 20 && a4 != 0) {
                            remarks += "&nbsp;<span class='label label-warning'> Low Stock </span>";
                        }

                        str += start + a1 + k + a2 + k + a3 + k + a4 + k + a5 + k + a6 + k + a7 + k + action + k + remarks + end;

                    };
                    str = str.replace(new RegExp("null", 'g'), "-");
                    $("#list tbody").html(str);




                    $('#list').DataTable({
                        responsive: true,
                        dom: 'Bfrtip',
                        buttons: [
                            'copyHtml5',
                            'excelHtml5',
                            'csvHtml5',
                            'pdfHtml5'
                        ]
                    });
                    // not showing while updating or deleting data

                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: "Data Loaded successfully",

                    });

                    $("#list").show(1000);
                    $("#tbl-main").show(1000);
                } else {
                    $("#msg").html(xmlHttp.status + ":" + xmlHttp.statusText);
                }
            }
        });
    }

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    function postData() {

        $.ajax({

            url: "https://localhost:44360/api/products",
            method: "post",
            headers: {
                ContentType: "application/json"
            },

            data: {

                ProductName: $("#ProductName").val(),
                ProductDescription: $("#ProductDescription").val(),
                Quantity: $("#Quantity").val(),
                Price: $("#Price").val()
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 201) {
                    $("#postmsg").html($("#ProductName").val() + " Created");

                    $("#ProductName").val(""),
                        $("#ProductDescription").val(""),
                        $("#Quantity").val(""),
                        $("#Price").val("")

                    loadData();

                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: "Data has been updated successfully"

                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: xmlHttp.status,
                        text: xmlHttp.statusText
                    });
                }
            },
            success: function () {
                var s = $("#ProductName").val() + "has been inserted successfully"

            }
        });
    }

    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    //update data
    function updateData() {

        var id = $("#updProductId").text();

        $.ajax({

            url: "https://localhost:44360/api/products/" + id,
            method: "put",
            headers: {
                ContentType: "application/json"
            },

            data: {

                ProductName: $("#updProductName").val(),
                ProductDescription: $("#updProductDescription").val(),
                Quantity: $("#updQuantity").val(),
                Price: $("#updPrice").val()
            },
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    $("#updatemsg").html($("#updProductName").val() + "Has Been Successfully Updated");

                    //empty update form
                    $("#updProductId").text("");
                    $("#updProductName").val(""),
                        $("#updProductDescription").val(""),
                        $("#updQuantity").val(""),
                        $("#updPrice").val("")

                    loadData();

                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: "Data has been updated successfully"

                    });

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: xmlHttp.status,
                        text: xmlHttp.statusText
                    });
                }
            }

        });
    }
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */
    function deleteData() {
        var id = $("#dltProductId").html();
        $.ajax({
            url: "https://localhost:44360/api/products/" + id,
            method: "delete",
            complete: function (xmlHttp, status) {
                if (xmlHttp.status == 200) {
                    //$("#deletemsg").html(id+" has been deleted successfully");
                    loadData();
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: "Product has been deleted successfully",

                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: xmlHttp.status,
                        text: xmlHttp.statusText,

                    })

                }
            }
        });
    }


    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //******************************************************************************************************************************************-->
    //*************************************************************************************************************** */




});